<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        
        Web Worker
    </title>
    <!-- 引入font-awesome图标 -->
    
<link rel="stylesheet" href="/css/font-awesome-4.7.0/css/font-awesome.min.css">
  

    
<link rel="stylesheet" href="/css/common.css">
  
    
<link rel="stylesheet" href="/css/layout.css">

    
    
        
<link rel="stylesheet" href="/css/post.css">

        
<link rel="stylesheet" href="/css/directory.css">

    
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
    <div class="navi-bar">
    
        
            <a class="navi-item" href="/" >
                首页
            </a>
            <!-- onclick="selectMenu('/')" -->
        
            <a class="navi-item" href="/archives" >
                归档
            </a>
            <!-- onclick="selectMenu('/archives')" -->
        
            <a class="navi-item" href="/demo/index.html" >
                vue2.x
            </a>
            <!-- onclick="selectMenu('/demo/index.html')" -->
        
            <a class="navi-item" href="/" >
                vue3.x
            </a>
            <!-- onclick="selectMenu('/')" -->
        
            <a class="navi-item" href="/" >
                计算机网络
            </a>
            <!-- onclick="selectMenu('/')" -->
        
    
</div>
    
    <div class="wrapper">
        <div class="tools-bar">	
            
                
                
                    <a target="_blank" rel="noopener" href="https://github.com/IDKHTS"><i class="fa fa-github tools-bar-icon"></i></a>
                
            
            <!-- <a href=""><i class="fa fa-weibo"></i></a>
            <a target="_blank" rel="noopener" href="https://github.com/IDKHTS"><i class="fa fa-github"></i></a> -->
            <i class="fa fa-angle-double-up tools-bar-icon" onclick="onScrollTop()"></i>
            <i class="fa fa-angle-double-down tools-bar-icon" onclick="onScrollBottom()"></i>
        </div>
        <div class="left">
            <div class="dirctory py-2 px-1 bg-white">
                
                    <div class="dirctory-text px-2 py-1 mb-1">目录</div>
                    
    <div>不存在的...</div>

                
            </div>
        </div >
        <div class="right">
            <div class="bg-white px-3 pb-3">
    <!-- 为了方便目录的渲染，不用h1等，直接写样式 -->
    <div class="post-h1 py-2">Web Worker</div>

    <div>
        <ul>
<li><p>面试的时候有被问到一个场景：一个页面渲染程的需要计算上亿的次的计算，如何可以将页面尽量快的完成渲染</p>
<ul>
<li>一开始以为是考<code>&lt;script&gt;</code>写的位置（body的底部），或者defer属性（先下载渲染后再加载），但是似乎都不是面试官想要的答案</li>
<li>直到学习到了Web Worker…</li>
</ul>
</li>
<li><p>Web Worker</p>
<ul>
<li><p>概述：由浏览器提供的web Api，主要是为了个js提供多线程的能力，另开一线程执行代码，<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Worker#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%85%BC%E5%AE%B9%E6%80%A7">兼容性</a></p>
</li>
<li><p>执行过程：使用代码<code>new Worker(&#39;url&#39;)</code>去加载url的代码（网络），然后在另外的线程执行url的代码，主线程和worker线程通过Worker.postMessage发送数据和window.onmessage接收数据来进行交互</p>
</li>
<li><p>限制：同源政策，内容安全策略（指定）</p>
</li>
<li><p>使用：</p>
<ul>
<li>main.js</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; main.js </span><br><span class="line">        if (window.Worker) &#123;</span><br><span class="line">            const ww &#x3D; new Worker(&#39;.&#x2F;worker.js&#39;);</span><br><span class="line">            let first &#x3D; document.querySelector(&#39;#first&#39;)</span><br><span class="line">                ww.postMessage(&#39;go&#39;)</span><br><span class="line">            &#x2F;&#x2F; first.onchange &#x3D; function (v) &#123;</span><br><span class="line">                &#x2F;&#x2F; console.log(v.target.value)</span><br><span class="line">                &#x2F;&#x2F; ww.postMessage(v.target.value)</span><br><span class="line">            &#x2F;&#x2F; &#125;</span><br><span class="line">            ww.onmessage &#x3D; function (e) &#123;</span><br><span class="line">                result &#x3D; e.data;</span><br><span class="line">                console.log(&#39;Message received from worker&#39;);</span><br><span class="line">                first.value &#x3D; result</span><br><span class="line">                ww.terminate();</span><br><span class="line">            &#125;</span><br><span class="line">            ww.onerror &#x3D; function(e)&#123;</span><br><span class="line">                console.log(&#39;get error %o&#39;,e)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            console.log(&#39;not support web worker&#39;)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>worker.js</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; worker.js</span><br><span class="line">onmessage &#x3D; function (e) &#123;</span><br><span class="line">    console.log(&#39;Message received from main script&#39;);</span><br><span class="line">    const start &#x3D; new Date().getTime()</span><br><span class="line">    let sum &#x3D; 0</span><br><span class="line">    for(let i&#x3D;0;i&lt;10000000000;i++)&#123;</span><br><span class="line">        sum +&#x3D; i</span><br><span class="line">    &#125;</span><br><span class="line">    console.log(new Date().getTime() - start)</span><br><span class="line">    console.log(&#39;Posting message back to main script&#39;);</span><br><span class="line">    postMessage(sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用后关闭主线程<code>worker.terminate()</code>，或这worker内部<code>close()</code></li>
</ul>
</li>
</ul>
</li>
<li><p>JavaScript是单线程的同时在浏览器中和GUI渲染的线程互斥，前面开头的提到的场景中：</p>
<ul>
<li><p>如果停下渲染html去执行计算，那么进入页面就会空白一段时间等js加载完再出现页面ui</p>
</li>
<li><p>如果使用把script直接放到html的body标签的最后，页面ui会渲染出来先，但在渲染完成后到js计算完成之前，页面ui交互可能会报错（计算未完成）；因为计算时间长，所以是可能在这段时间用户进行ui交互（可以加个“加载中”动画缓解用户焦虑，类似请求完成前一直loading)</p>
<p><code>time = renderHtml + downloadJs + runJs</code></p>
</li>
<li><p>如果使用<code>&lt;script&gt;</code>的defer,可以先并行下载后执行，相对上一点只是节省了一下下载时间（几乎忽略不计）</p>
<p><code>time = max(renderHtml, downloadJs) + runJs</code></p>
</li>
<li><p>如果使用web worker，先直接加载使用worker的js代码，然后渲染html；因为是另开线程来执行，所以不阻塞html渲染，页面ui应该会马上出来；因为页面和js计算基本同时执行，所以如果计算较大，使用Web Worker是最快的；</p>
<p><code>time = max(renderHtml, downloadJs + runJs)</code></p>
</li>
<li><p>当然无论如何，计算量大总是会有问题，所以加个加载动画是最好的，让用户看到页面又屏蔽用户的操作。</p>
</li>
</ul>
</li>
</ul>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.ruanyifeng.com/blog/2018/07/web-worker.html">Web Worker 使用教程</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers">使用 Web Workers</a></p>

    </div>
</div>

    <section class="comments" id="comments">
        <div id="gitalk-container"></div>
        <!-- <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
        <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script> -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
        <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
        <script>
            let admins = 'IDKHTS'
            let arrPathName = (location.pathname).split("/")
            let gitalkID = ''
            for (let i = arrPathName.length - 1; i >= 0; i--) {
                if (arrPathName[i] != '') { gitalkID = arrPathName[i].substring(0, 49); break }
            }
            // console.log(gitalkID)
            var gitalk = new Gitalk({
                clientID: '884f505b74829948187e',
                clientSecret: '4e414213f820b3ddde39e15a53c2b5a70c301c5d',
                repo: 'idkhts.github.io',
                owner: 'IDKHTS',
                admin: admins.split(','),
                id: gitalkID,//location.pathname,  // Ensure uniqueness and length less than 50
                perPage: 50,
                distractionFreeMode: 'false'
            })

            gitalk.render('gitalk-container')
        </script>
    </section>
    

<!-- 
    page的属性
'title',          '_content',
'source',         'raw',
'slug',           'published',
'date',           'updated',
'comments',       'layout',
'photos',         'link',
'_id',            'content',
'site',           'excerpt',
'more',           'path',
'permalink',      'full_source',
'asset_dir',      'tags',
'categories',     'next',
'__post',         'lang',
'canonical_path' -->
        </div>
    </div>

    

    
<script src="/js/layout.js"></script>

    
    
        
<script src="/js/post.js"></script>

    
</body>

</html>